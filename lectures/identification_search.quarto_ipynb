{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "# The Search Model\n",
        "\n",
        "## Identification of the Model without Heterogeneity\n",
        "\n",
        "The @Mccall Search Model that we introduced as a [prototype model](../models/search.qmd) is an excellent introduction to the identification of structural models. A classic treatment of identification of this model is provided by @flinn1982. \n",
        "\n",
        "\n",
        "### Data\n",
        "\n",
        "Identification arguments *always* begin with an assumption on available data. Even though the model is dynamic, we will show that all we really need is a single cross-section of data:\n",
        "\n",
        "$$ (E_{n},t_{U,n},W_{n})_{n=0}^{N} $$\n",
        "\n",
        "where :\n",
        "\n",
        "- $E_{n}\\in\\{0,1\\}$ indicates the employment status of individual $n$\n",
        "- If the individual is employed ($E_{n}=1$) we see the wage, $W_{n}$, which is otherwise assumed to be missing.\n",
        "- If the individual is unemployed ($E_{n}=0$), then we see the duration of unemployment $t_{U,n}$, which is otherwise assumed to be missing.\n",
        "\n",
        "::: {.callout-note icon=\"false\" collapse=\"true\"}\n",
        "## Example: CPS Data\n",
        "\n",
        "::: {#exm-CPS_data}\n",
        "### Reading the data\n",
        "Let's take a look at data from the CPS on wages, employment status, and labor market transitions. Here is code to read in the data:\n"
      ],
      "id": "4ee8bcbd"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "using CSV, DataFrames, DataFramesMeta, Statistics\n",
        "\n",
        "data = CSV.read(\"../data/cps_00019.csv\",DataFrame)"
      ],
      "id": "03a7d7a3",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "As you can see from the preview of the data, the data is taken from January-March 2018. Here is a quick snippet of code to see how many observations we have on average per person:\n"
      ],
      "id": "abe0bd1a"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "@chain data begin\n",
        "    groupby(:CPSIDP)\n",
        "    @combine :T = length(:EMPSTAT)\n",
        "    @combine :average = mean(:T) :frac_panel = mean(:T.>1)\n",
        "end"
      ],
      "id": "d5c87922",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "So we see that more than half of the individuals in this sample can be found in more than one month of the data.\n",
        "\n",
        "The `@chain` macro comes from the package `DataFramesMeta` and is a convenient syntax for composing operations into one block. For example:\n"
      ],
      "id": "86445fa1"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| eval: false\n",
        "@chain x begin\n",
        "    func1(y1)\n",
        "    func2(y2)\n",
        "    func3(y3)\n",
        "end"
      ],
      "id": "62362bc9",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "is equivalent to\n"
      ],
      "id": "1acb51ad"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| eval: false\n",
        "func3(func2(func1(x,y1),y2),y3)"
      ],
      "id": "39bdcb34",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        ":::\n",
        "\n",
        "::: {#exm-CPS_moments}\n",
        "### Calculating some moments\n",
        "\n",
        "You may find the [codebook](/data/CPS-Codebook.html) useful for understanding particular variables. We have already limited the data to individuals who are working (`EMPSTAT`=10), have a job but did not work last week (`EMPSTAT`==12), or are unemployed (`EMPSTAT`==21).\n",
        "\n",
        "Suppose we wanted to use the panel dimension to measure transition rates. Here is a simple way to do that by simply measuring transitions between January and Feburary.\n"
      ],
      "id": "08a1324b"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "data[!,:E] .= data.EMPSTAT.<21 #<- code the employment variable\n",
        "\n",
        "data_jan = @chain data begin\n",
        "    @subset :MONTH.==1\n",
        "    @select :CPSIDP :AGE :SEX :EDUC :RACE :E\n",
        "    @rename :E_lag = :E\n",
        "end\n",
        "\n",
        "data_merged = @chain data begin\n",
        "    @subset :MONTH.==2\n",
        "    @select :CPSIDP :E\n",
        "    innerjoin(data_jan,on=:CPSIDP)\n",
        "end"
      ],
      "id": "1ad9149c",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "So now we can calculate the overall transition rate out of unemployment:\n"
      ],
      "id": "ae861636"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "@combine data_merged begin\n",
        "    :EU =  1-mean(:E[:E_lag.==1])\n",
        "    :UE = mean(:E[:E_lag.==0])\n",
        "end "
      ],
      "id": "7234006b",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "So here we're estimating a very low separation rate and a pretty high hazard rate out of unemployment.\n",
        ":::\n",
        ":::{#exm-CPS_hetero}\n",
        "#### Observable heterogeneity\n",
        "\n",
        "Next we'll define a very simple education classification (Bachelor's degree or not) and race classification (white vs non-white), and use `groupby` to calculate rates separately by demographics:\n"
      ],
      "id": "7a5bf458"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "@chain data_merged begin\n",
        "    @transform begin\n",
        "        :bachelors = :EDUC.>=111\n",
        "        :nonwhite = :RACE.!=100 \n",
        "    end\n",
        "    groupby([:bachelors,:nonwhite,:SEX])\n",
        "    @combine begin\n",
        "       :EU =  1-mean(:E[:E_lag.==1])\n",
        "       :UE = mean(:E[:E_lag.==0])\n",
        "    end \n",
        "end"
      ],
      "id": "5cbfc8e9",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "What do these differences in transition rates tell you about how we should extend the simple model with homogenous parameters?\n",
        ":::\n",
        ":::\n",
        "\n",
        "### Steady State\n",
        "\n",
        "A key assumption for identification in this case is that the economy is in **steady state**. Let $U_{t}$ be fraction of individuals that are unemployed at time $t$. Let $p_{\\tau,t}$ be the fraction of individuals at time $t$ with unemployment duration $\\tau$. In general, these objects evolve according to the rules:\n",
        "\n",
        "\\begin{eqnarray}\n",
        "U_{t+1} = (1-h)U_{t} + \\delta (1-U_{t+1}) \\\\\n",
        "p_{\\tau+1,t+1} = (1-h)p_{\\tau,t} \\\\\n",
        "p_{0,t+1} = \\delta (1-U_{t})\n",
        "\\end{eqnarray}\n",
        "where $h$ is the \"hazard rate\" of exiting unemployment, $\\lambda(1-F_{W}(w^*))$. Enforcing that these objects are constant between $t$ and $t+1$ (the steady state assumption) gives:\n",
        "\n",
        "\\begin{eqnarray}\n",
        "U_{t} = \\frac{\\delta}{\\delta+h} \\\\\n",
        "p_\\tau = \\frac{\\delta h}{\\delta+h}(1-h)^{\\tau}\n",
        "\\end{eqnarray}\n",
        "\n",
        "### Writing Joint Probabilities\n",
        "\n",
        "With these probabilities in hand, we can write the sampling distribution $\\mathbb{P}$ in terms of equilibrium objects:\n",
        "\n",
        "$$ \\mathbb{P}(E,t_U,W) = \\left(\\frac{h}{h+\\delta}F_{W}(W|W>w^*)\\right)^{E}\\left(\\frac{\\delta h}{\\delta+h}(1-h)^{t_{U}}\\right)^{1-E} $$\n",
        "\n",
        "### Thinking Through Identification\n",
        "\n",
        "Often it is helpful to break down the joint distribution of observables into unconditional and conditional distributions. Notice here that:\n",
        "\n",
        "$$ \\mathbb{P}(t_{U}|E=0) = h\\times(1-h)^{t_{U}} $$\n",
        "\n",
        "and so the hazard rate $h$ can be inferred from the distribution of unemployment durations.\n",
        "\n",
        "Next, notice that the probability of being unemployed is \n",
        "\n",
        "$$ \\mathbb{P}(E=0) = \\frac{\\delta}{\\delta+h} $$\n",
        "\n",
        "and so $\\delta$ is given by $h$ (which we now know) and the fraction of unemployed.\n",
        "\n",
        "Finally, we see that\n",
        "\n",
        "$$ \\mathbb{P}(W|E=1) = F_{W}(W|W>w^*) $$\n",
        "\n",
        "Observed wages are equal to the offer distribution *conditional on the wage offer being acceptable*. This tells us that, although the conditional distribution can be identifiable, we do not know the distribution of wage offers that are never accepted (those below $w^*$). Let $\\underline{w}$ be the lower bound on the support of the sampling distribution $\\mathbb{P}$. Clearly, $w^*$ is identified since:\n",
        "\n",
        "$$ w^* = \\underline{w} $$\n",
        "\n",
        "Can we identify the deeper structural parameters, $b$, $\\lambda$, and $\\beta$? Not quite. Let's rewrite the reservation wage equation as:\n",
        "\n",
        "$$ w^* = b + \\beta h\\int_{w^*}\\frac{1-F(W|W>w^*)}{1-\\beta(1-\\delta)}dw $$\n",
        "\n",
        "and we can see that infinitely many combinations of $b$ and $\\beta$ can rationalize the same reservation wage. Assuming a plausible value for $\\beta$ (you will learn that this is common across many structural estimation exercises), $b$ is identified by this equation.\n",
        "\n",
        "## Credibility and a Policy Counterfactual\n",
        "\n",
        "Suppose we used this model to forecast the effect of a tax credit $\\tau$ that is proportional to earnings. Under the counterfactual the value function $V$ becomes:\n",
        "\n",
        "$$ V(w) = (1+\\tau)w + \\delta U + (1-\\delta) V(w) $$\n",
        "\n",
        "Repeating the previous derivation gives a new reservation wage equation:\n",
        "\n",
        "$$ w^* = \\frac{b}{1+\\tau} + \\frac{\\beta\\lambda}{1-\\beta(1-\\delta)} \\int_{w^*}[1-F_{W}(w)]dw $$\n",
        "\n",
        "and so we see that the effect of the subsidy in the model is equivalent to reducing the flow utility of unemployment. \n",
        "\n",
        "It is simple to forecast the effect of the policy counterfactual: we take our estimates and re-calculate the reservation wage. However notice that since the reservation wage will decrease in response to the tax credit, our forecast of the effect depends on an arbitrary parametric assumption that we had to make in order to identify the distribution of wages below the reservation wage $w^*$.\n",
        "\n",
        "Things look slightly better if we were to impose a tax ($\\tau<0$) since this at would use information about the wage distribution that is directly observable, but the underlying identifying assumption is particularly stark: it says that the policy's effect can essentially be inferred from the cross-sectional distribution of wages without any existing policy variation to speak of.\n",
        "\n",
        "::: {.callout-warning icon=\"false\"}\n",
        "## Discussion\n",
        "Does this seem like a credible way to identify the causal impact of the tax subsidy?\n",
        ":::\n",
        "\n",
        "::: {.callout-note}\n",
        "One thing to note about this discussion: while the initial identification discussion seems intuitive and reasonable, it takes a new light once we arrive that the *specific research question of interest*. Conceptually it is important to view the strengths and weaknesses of identification through the lens of desired counterfactuals.\n",
        ":::\n",
        "\n",
        "## Identification of the model with an exclusion restriction\n",
        "\n",
        "Suppose that we have access to a variable $Z$ that enters the model only by moving the flow utility from unemployment. We can re-write the reservation wage equation as:\n",
        "\n",
        "$$ w^*(z) = b(z) + \\frac{\\beta\\lambda}{1-\\beta(1-\\delta)}\\int_{w^*(z)}[1-F_{W}(w)]dw $$\n",
        "\n",
        "We'll refer to $Z$ as an excluded variable because it effects selection into and out of jobs without moving the distribution of offered wages. Let $\\underline{w}(z)$ be the lower bound on the support of the *conditional* sampling distribution of wages $\\mathbb{P}(W|E=1,Z)$ and let $\\underline{w}_{F}$ be the lower bound on the support of the offer distribution $F_{W}$. \n",
        "\n",
        "As before, we know that $w^*(z) = \\underline{w}(z)$. Now suppose there is sufficient movement in $Z$ such that the set\n",
        "\n",
        "$$ \\underline{\\mathcal{Z}} = \\{z: w^*(z)\\leq \\underline{w}_{F}\\} $$\n",
        "\n",
        "has positive measure. This gives $\\underline{w}_{F} = \\inf_{z}\\underline{w}(z) = \\underline{w}$ and the set itself is identified as:\n",
        "\n",
        "$$ \\underline{\\mathcal{Z}} = \\{z: \\underline{w}(z)=\\underline{w}\\} $$\n",
        "\n",
        "The unconditional distribution $F_{W}$ is non-parametrically identified by simply looking at the distribution of wages for values of $Z$ where the lower bound of the support achieves this minimum:\n",
        "\n",
        "Identification of all other parameters can be pursued non-parametrically as a function of $z$.\n",
        "\n",
        "\n",
        "$$ F_{W}(w) = \\mathbb{P}(w | E = 1, z),\\ z \\in \\underline{\\mathcal{Z}} $$\n",
        "\n",
        ":::{.callout-note}\n",
        "Forecasting the effect of the policy now makes use of *articulated variation*. The model casts variation that scales wages as being equivalent to variation in the value of unemployment $b$, for which we now have a source. This means that we can recreate the experiment by interpolating existing variation in $b$. \n",
        ":::\n",
        "\n",
        "### Further identification by functional form\n",
        "\n",
        "Suppose that $b(z)$ takes a linear form:\n",
        "\n",
        "$$ b(z) = b_0 + b_1 z. $$\n",
        "\n",
        "In this case, for three values ($z,z',z''$) we can write:\n",
        "\n",
        "$$ w^*(z')-w^*(z) = b_1(z'-z) + \\frac{\\beta\\lambda}{1-\\beta(1-\\delta)}\\int_{w^*(z)}^{w*(z')}[1-F_{W}(w)]dw $$\n",
        "$$ w^*(z'')-w^*(z) = b_1(z''-z) + \\frac{\\beta\\lambda}{1-\\beta(1-\\delta)}\\int_{w^*(z)}^{w*(z'')}[1-F_{W}(w)]dw $$\n",
        "\n",
        "which is sufficient to identify the two unknowns in the equation, $\\beta$ and $b_1$. Thus, $\\beta$ is identified by additional functional form restrictions.\n",
        "\n",
        ":::{.callout-warning icon=\"false\"}\n",
        "## Discussion\n",
        "- Notice that now the policy counterfactual is given by additional parameters that attempt to match how wages and hazard rates respond to existing policy variation. \n",
        "- How do you feel about this approach relative to the case without variation? \n",
        "- How do you feel about the model's key implication that variation in $b$ is equivalent to variation in $\\tau$?\n",
        "- What would be an alternative and potentially preferable source of variation?\n",
        ":::\n",
        "\n",
        "### Identification with known scale restrictions\n",
        "\n",
        "There are cases where it would be reasonable to assume a known relationship $b(z)$. For example, if $Z$ is a random policy variable that tells us the generosity of welfare payments. To be consistent with our specification of utility while employed, we should then write:\n",
        "\n",
        "$$ b(z) = b_0 + Z $$\n",
        "\n",
        "and here $\\beta$ would be identified. \n",
        "\n",
        ":::{.callout-note}\n",
        "Not only is $\\beta$ identified in this case, but we can see that it is a key parameter for matching the effect of $Z$, and hence will be a key parameter in determining the response of reservation wages and hazard rates to the policy.\n",
        ":::\n",
        "\n",
        "\n",
        "### The Whether vs How of Identification\n",
        "\n",
        "Let's now assume that we have access to two instruments, $(Z_{1},Z_{2})$. The former shifts $b$, as in the previous example, while the latter shifts wages. $Z_{2}$ could be a plausible instrument for labor demand, or if we wanted to think of $W$ as net wages, $Z_{2}$ could represent a policy variable that sets marginal tax rates. Let's assume that:\n",
        "\n",
        "$$ \\log(W) = \\log(\\omega) + \\log(\\mu(Z_{2})),\\ Z_{2} \\perp \\omega $$\n",
        "\n",
        "where $\\omega \\sim F_{\\omega}$ is the component of wages net of $Z_{2}$. The reservation wage formula can be written in terms of $\\omega^*$:\n",
        "\n",
        "$$ \\omega^*(z_1,z_2) = \\frac{b(z_1)}{\\mu(z_2)} + \\frac{\\beta\\lambda}{1-\\beta(1-\\delta)}\\int_{\\omega^*(z_1,z_2)}(1-F_{\\omega}(\\omega))d\\omega $$\n",
        "\n",
        "Fixing $Z_{2}$, let $Z_{1}$ have the same support conditions as in the previous section, implying that $F_{W}(W|Z_2)$ is identified for all $Z_{2}$ in an appropriately defined subset of its support. Notice that the location of the distribution of $F_{\\omega}$ and the location of $\\mu$ are not separately identified. Hence, we are free to normalize $\\mathbb{E}[\\omega] = 0$ such that $\\log(\\mu(Z)) = \\mathbb{E}[\\log(W)|Z_2]$, and hence $\\mu(z)$ is non-parametrically identified by the conditional mean of $\\log(W)$ when $Z_{1}$ is in the region of it's support where $\\omega^*(Z_1,Z_2)\\leq \\underline{\\omega}$.\n",
        "\n",
        "In order to introduce the **whether** versus the **how** of identification, let us begin with the observation that the model is *over-identified*: we only need a subset of the available data to identify the model. For example, note that hazard rates out of unemployment are:\n",
        "\n",
        "$$ h(z_1,z_2) = \\lambda (1-F_{\\omega}(\\omega^*(z_1,z_2))) $$\n",
        "\n",
        "As we now know, the hazard rate $h(z_1,z_2)$ can be identified directly by the distribution of durations, conditional on $z_1,z_2$. But notice that $h(z'_1,z'_2)/h(z_1,z_2) = (1-F_\\omega(\\omega^*(z_1,z_2)))/(1-F_{\\omega}(\\omega^*(z_1,z_2)))$ where the right hand side consists of objects that are directly identified from wage data. \n",
        "\n",
        "Now you can go one of two ways: you can enrich the model based on the observation that you have many \"spare\" features of the data that could be used to identify this extra richness. **Or** you could decide that your model is sufficiently detailed to answer your question of interest (shout out @Marschak1953), and choose the estimation approach that makes your answer most credible. Since the model is undoubtedly misspecified, you will have to make peace with the idea that your model will not match every feature of the data simultaneously. This is the **how** of identification: which features of the data will you use to identify and estimate your model to make the answer to your question of interest most credible?\n",
        "\n",
        ":::{.callout-important icon=\"false\"}\n",
        "## The \"how\" of identification\n",
        "When your model is over-identified, which features of the data will you use to identify and estimate your model?\n",
        ":::\n",
        "\n",
        "Here are two potential tensions from our example:\n",
        "\n",
        "1. As we discussed above: the shape of the hazard function is identified directly from wage data. Hazard rates are important because they determine unemployment rates, and their responsiveness to $Z_1$ and $Z_2$ determine the how unemployment rates shift with these variables.\n",
        "2. The reservation wage equation above shows that the model treats changes in $Z_1$ and $Z_2$ through the same mechanism. The model requires that variation in these two variables have an identical effect on reservation wages (and hence hazard rates). This is a strong restriction that would likely not hold in extended versions of the model. Would we want identification to rely on this property if we didn't have to?\n",
        "\n",
        "How should we approach these tensions? Just as @Marschak1953 did, let's return to the **question of interest**. We want to evaluate a policy counterfactual that varies marginal tax rates. Wouldn't this be most convincing if we show that the model parameters have been chosen to replicate the effects of pre-existing variation that is functionally identical? Some options along these lines:\n",
        "\n",
        "1. [Minimum Distance] Choose structural parameters to match --- along with more fundamental moments --- moments based on the joint distribution of unemployment durations and $z_2$. \n",
        "2. [Indirect Inference] Compute some quasi-experimental estimates of the effect of $Z_2$ on wages and hazard rates, and \n",
        "3. [Maximum Likelihood] Maximize the log-likelihood, and validate ex-post that the model can fit observed changes in the hazard rate with respect to $Z_2$, or replicate the results of a quasi-experimental study. This would show that even though the model is overi-identified, it is still using the sources of variation that we view conceptually as being most appropriate.\n",
        "\n",
        "In the next section of this course, we will review the asymptotic properties of these estimators and discuss practical issues related to implementation.\n",
        "\n",
        "::: {.callout-warning icon=\"false\"}\n",
        "## Discussion\n",
        "- How do you think approach compares to the case where we did not have plausible exogenous variation in wages?\n",
        "- How do you think it compares to the case where we had exogenous variation in tax rates explicitly (rather than intepolating via articulated variation: wage rates and marginal tax rates have identical effects).\n",
        ":::\n",
        "\n",
        "## Identification with unobserved heterogeneity\n",
        "\n",
        "Now suppose that we allow for $K$ *unobserved types* with population proportions given by $\\pi=\\{\\pi_{k}\\}_{k=1}^{K}$ that enter the model through the value of unemployment. Assume that we have an instrument $Z$ that shifts the flow value of unemployment in a known way:\n",
        "\n",
        "$$ b_{k}(Z) = b_{k} + Z $$\n",
        "\n",
        "such that we get $K$ latent reservation wages:\n",
        "\n",
        "$$ w^*_{k}(z) = b_{k} + Z + \\frac{\\beta\\lambda}{1-\\beta(1-\\delta)}\\int_{w^*_{k}(z)}[1-F_{W}(w)]dw $$\n",
        "\n",
        "This gives a vector of latent hazard rates $h_{k}(z)$ for all values of the instrument $z$. The distribution of hazard rates is itself a mixture:\n",
        "\n",
        "$$ \\mathbb{P}(t_U=t|E=0,Z) = \\sum_{k}\\tilde{\\pi}_{k}h_{k}(z)(1-h_{k}(z))^{t} $$\n",
        "\n",
        "where $\\tilde{\\pi}_{k}$ denotes the representation of each type among the unemployed: \n",
        "\n",
        "$$\\tilde{\\pi}_{k} = \\frac{\\pi_{k}\\frac{\\delta}{\\delta+h_{k}(z)}}{U(z)} $$\n",
        "\n",
        "@heckman1984 show that, for a fixed $K$, the parameters $(\\tilde{\\pi}_{k},h_{k}(z))$ are identified from this distribution of durations.\n",
        "\n",
        "::: {.callout-tip icon=\"false\"}\n",
        "## Exercise\n",
        "::: {#exr-search_unobs_hetero}\n",
        "Complete the identification argument for this model by following these steps:\n",
        "\n",
        "1. Argue that the vector $\\pi$ and $\\delta$ can be inverted from $\\tilde{\\pi}$ and the unemployment rate $U(z)$.\n",
        "1. State an assumption on the support of $Z$ such that $F_{W}$ is identified in some part of the support of $Z$.\n",
        "2. Argue that $\\lambda$ is identified for $Z$ in this same region of the support.\n",
        "3. Argue that each $w_{k}^*(z)$ is identified from $h_{k}(z)$ and $F_{W}$.\n",
        "4. Use the reservation wage equation to argue that each $b_{k}$ and $\\beta$ is identified.\n",
        ":::\n",
        ":::\n",
        "\n",
        "\n",
        "<!-- Can we show that the model is not identified and that we need panel data? -->"
      ],
      "id": "139e864c"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "julia-1.11",
      "language": "julia",
      "display_name": "Julia 1.11.3",
      "path": "/Users/mullinsj/Library/Jupyter/kernels/julia-1.11"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}