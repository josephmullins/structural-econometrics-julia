{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "# The Life-Cycle Savings Model\n",
        "\n",
        "We'll consider identification of the [savings model](../models/savings.qmd) with the following income process:\n",
        "\n",
        "$$ \\log(y_{n,t}) = \\mu_{t} + \\varepsilon_{n,t}$$\n",
        "\n",
        "where\n",
        "\n",
        "$$ \\varepsilon_{n,t+1} = \\rho \\varepsilon_{n,t} + \\eta_{n,t},\\qquad \\eta_{m,t}\\sim\\mathcal{N}(0,\\sigma^2_\\eta) $$.\n",
        "\n",
        "Collecting parameters, we want to identify\n",
        "\n",
        "$$ (\\mu,\\rho,\\sigma_\\eta),\\qquad (\\beta,\\sigma,\\psi) $$\n",
        "\n",
        "where the first block indicates parameters of the income process, and the second block determines preferences.\n",
        "\n",
        "## Identification of the Income Process\n",
        "\n",
        "Assume that our data has a panel dimension, so that we see $(y_t,C_t,t)_{t=\\tau_0}^{\\tau_1}$ for some pair $(\\tau_0,\\tau_1)$. Remember that $t$ indexes age in the model, so it is quite plausible that $\\tau_0$ and $\\tau_1$ may themselves be random variables (this will be true in the data... we see panels of individuals at different ages and for different lengths of time). \n",
        "\n",
        "First, as long as the support of the random variables ($\\tau_0,\\tau_1$) covers $t=1$ through to $T$, $\\mu$ is identified as the mean of log income at each age, $\\mu_t = \\mathbb{E}[\\log(y_{t})]$. We can then residualize log income to get $\\varepsilon_{t} = \\log(y_t)-\\mu_t$. \n",
        "\n",
        "Second, consider the following variances and covariances (remember that the $\\eta$ terms are iid):\n",
        "\n",
        "\\begin{eqnarray}\n",
        "\\mathbb{V}[\\varepsilon_{t+1}] = \\rho^2\\mathbb{V}[\\varepsilon_{t}] + \\sigma^2_{\\eta} \\\\\n",
        "\\mathbb{C}(\\varepsilon_{t},\\varepsilon_{t+1}) = \\rho\\mathbb{V}[\\varepsilon_{t}] \\\\\n",
        "\\mathbb{C}(\\varepsilon_{t},\\varepsilon_{t+2}) = \\rho^2\\mathbb{V}[\\varepsilon_t]\n",
        "\\end{eqnarray}\n",
        "\n",
        "meaning that we can identify $\\rho$ and $\\sigma_\\eta$ from this system of simultaneous equations.\n",
        "\n",
        ":::{.callout-important icon=\"false\"}\n",
        "## Note: Whether vs How\n",
        "Note that, since these moments can be calculated at any age $t$ and can extend to arbitrary lags, this model is **over-identified**. Which moments should we use in practice? Thinking *inside* the model, we will address this topic when we get to discussing *minimum distance estimation*. You might also like to think outside the model and think about (1) how real income processes might deviate from your stylized model and (2) what features of the data you most want the parameters $\\rho$ and $\\sigma^2$ to capture.\n",
        ":::\n",
        "\n",
        "\n",
        ":::{.callout-note icon=\"false\"}\n",
        "## Example: Data from PSID\n",
        ":::{#exm-psid}\n",
        "In this example we'll load psid data from @ABB_2018 and show how sample equivalents to the above moments might be calculated.\n",
        "\n",
        "To begin, let's load the data and pull out the variables we are interested in using. These are person identifiers (`person`), year, total income (`y`), savings (`tot_assets1`) and age. You should bear in mind that it is by no means trivial to measure total income and total assets in these data. The variables we are looking at are the product of a lot of data cleaning and careful choices by the authors.\n"
      ],
      "id": "5217bdc7"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "using CSV, DataFrames, DataFramesMeta, Statistics\n",
        "data = @chain begin \n",
        "    CSV.read(\"../data/abb_aea_data.csv\",DataFrame,missingstring = \"NA\")\n",
        "    @select :person :y :tot_assets1 :asset :age :year\n",
        "end"
      ],
      "id": "d910857d",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "To map to the model, assume that agents begin ($t=1$) when aged 25 and live for 40 years (so the \"terminal\" period is at age 64). Thus, we should filter the data to look at only these ages.\n"
      ],
      "id": "3123fe5d"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "@subset!(data,:age.>=25,:age.<=64);"
      ],
      "id": "5a6b81f8",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "Now let's residualize log wages by age, to get our estimate of $\\varepsilon_{n,t}$:\n"
      ],
      "id": "aa4d6ccc"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "data = @chain data begin\n",
        "    groupby(:age)\n",
        "    @transform :eps = log.(:y) .- mean(log.(:y))\n",
        "end;"
      ],
      "id": "f7dadbde",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "Next, here is a simple way of creating lagged variables (by mutating the year, renaming, and merging).\n"
      ],
      "id": "f4f8d023"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "d1 = @chain data begin\n",
        "    @select :year :person :eps\n",
        "    @transform :year = :year .- 2\n",
        "    @rename :epslag1 = :eps\n",
        "end\n",
        "\n",
        "d2 = @chain data begin\n",
        "    @select :year :person :eps\n",
        "    @transform :year = :year .- 4\n",
        "    @rename :epslag2 = :eps\n",
        "end\n",
        "\n",
        "data = @chain data begin\n",
        "    innerjoin(d1 , on=[:person,:year])\n",
        "    innerjoin(d2 , on=[:person,:year])\n",
        "end;"
      ],
      "id": "b69ba4c2",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "An example of calculating covariances:\n"
      ],
      "id": "4872d70c"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "@chain data begin\n",
        "    @combine begin \n",
        "        :c1 = cov(:eps,:epslag1) \n",
        "        :c2 = cov(:eps,:epslag2)\n",
        "    end\n",
        "end;"
      ],
      "id": "0f507362",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "Since the psid interviews are only every two years, we have to adjust our estimate of $\\rho$ slightly by taking the square root of the covariance ratio:\n"
      ],
      "id": "aea61dda"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "rho_est = sqrt(ans.c2[1] / ans.c1[1])\n",
        "println(\"The estimate of rho is $(round(rho_est,digits=2))\")"
      ],
      "id": "02f01d04",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "When it comes to the identification of this income process, let's consider its ability to fit the life-cycle profile in the variance of income:\n"
      ],
      "id": "aa499449"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "using Plots\n",
        "d = @chain begin data\n",
        "    groupby(:age)\n",
        "    @combine :var_income = var(log.(:y))\n",
        "end\n",
        "scatter(d.age,d.var_income,smooth = true,label = false)"
      ],
      "id": "c1428161",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "The variance of log income seems to grow linearly with age, so this would be hard for our income process to fit if either\n",
        "\n",
        "1. We assume that $\\varepsilon$ is initially in its stationary distribution; or\n",
        "2. $\\rho$ is far from 1, since it implies a concave path for the variance.\n",
        "\n",
        ":::\n",
        ":::\n",
        "\n",
        ":::{.callout-tip icon=\"false\"}\n",
        ":::{#exr-income_process}\n",
        "Suppose that income processes also feature permanent differences in productivity among individuals, so that:\n",
        "\n",
        "$$ \\log(y_{n,t}) = \\mu_t + \\alpha_n + \\varepsilon_{n,t} $$\n",
        "\n",
        "where $\\varepsilon_{n,t}$ is defined as before, and $\\alpha_n$ is the individual fixed effect in wages. Assume that $\\alpha\\perp \\varepsilon_1$, $\\alpha \\perp \\eta_t$ for all $t$, and define $\\sigma^2_\\alpha = \\mathbb{V}[\\alpha]$. \n",
        "\n",
        "1. Show that you can identify this income process using additional covariances.\n",
        "2. Estimate the parameters $(\\rho,\\sigma^2_\\alpha,\\sigma^2_\\eta)$  by following your identification argument using the psid data from @exm-psid.\n",
        "3. How do your estimates compare to @exm-psid where we ignored permanent individual heterogeneity? \n",
        ":::\n",
        ":::\n",
        "\n",
        "## Identification of Preference Parameters\n",
        "\n",
        "This is an interesting case because the problem will likely more closely reflect how you will approach identification in your own research.\n",
        "\n",
        "In previous examples, we typically made use of analytical (i.e. \"pencil and paper\") representations of optimal behavior as they relate to deeper parameters, and we used this for identification. That is harder to do here since we know we must solve for savings policies numerically. \n",
        "\n",
        ":::{.callout-note}\n",
        "## Identification of more complicated models\n",
        "\n",
        "Here are some steps to help you think through identification of your model.\n",
        "\n",
        "1. Could you obtain identification if you had a \"perfect\" data set or experiment? Do your data allow a second-best approximation that harnesses the intuition of this perfect alternative? Remember that to show identification you can dispense with the practical considerations of finite samples and zoom in on very specific comparisons within the population distribution.\n",
        "2. What kind of variation is in the data that you *do* have and how do the parameters determine individuals' response to that variation? If necessary, you can play with numerical solutions of the model to develop your intuition here.\n",
        "3. Can you simplify your model in a way that highlights some of the key forces of identification?\n",
        "\n",
        ":::\n",
        "\n",
        "These approaches all differ in their level of precision. Your main goal is to provide your audience and yourself with some credible and sensible intuition. For the savings model, let's use some combination of strategies (2) and (3). First, note that when $\\psi=0$, individuals would run their assets down to zero in the final period. Thus, $\\psi$ is very clearly identified by average bequests at the end of the life-cycle.\n",
        "\n",
        "Now, suppose we remove uncertainty from the model and impose the natural borrowing constraint, such that the Euler equation becomes:\n",
        "\n",
        "$$ \\beta(1+r)\\left(\\frac{C_{t+1}}{C_{t}}\\right)^{-\\sigma}=1 $$\n",
        "\n",
        "Notice that $\\sigma$ determines the *intertemporal elasticity of substitution*: how individuals would substitute consumption across periods when there is variation in the price of doing so ($r$). What sources of variation do we have in this model? Only the income shocks $\\eta$. Without uncertainty, individuals then choose a consumption profile based on the effect of that shock on the net present value of income. The resultant path depends on $\\beta$, $r$, and $\\sigma$, but importantly $\\beta$ and $\\sigma$ are *not separately identified*. Thus, uncertainty and borrowing constraints hold the key for separately identifying parameters in our setting.\n",
        "\n",
        "Now, we know from experimenting with this model that as individuals accumulate assets, the risk of hitting the borrowing constraint diminishes and their behavior begins to more closely reflect the case without uncertainty: consumption responses are very close to linear with respect to cash in hand. Thus, to identify $\\beta$ and $\\sigma$ separately, we need to focus on potential nonlinearities in consumption behavior closer to the borrowing constraint. One example of a set of identifying moments would be:\n",
        "\n",
        "1. Mean assets at each age; and\n",
        "2. The covariance of changes in log consumption with log income conditional on different asset levels.\n",
        "\n",
        "While the first set of moments should pin down $\\beta$ and $\\psi$ jointly by effectively matching average consumption profiles, the second set attempts to pin down the nonlinear effect that $\\sigma$ has on consumption at different wealth levels.\n",
        "\n",
        "As you can see, this is a sensible intuitive approach to identification that does not offer an exact mapping between data and parameters.\n",
        "\n",
        "Since $\\sigma$ determines both risk aversion and the intertemporal elasticity of substitution, some ideal data settings that would identify $\\sigma$ would include:\n",
        "\n",
        "1. The risk profile of asset portfolio choices (we don't have this).\n",
        "2. Variation in the income risk faced by individuals (we don't have this).\n",
        "3. Variation in the returns to saving either through $r_t$ or through policy intervention (we don't have this).\n",
        "\n",
        "In general then there are many ways to identify $\\sigma$, but most are missing in our simple model, so we will have to be more careful with the moments we choose.\n",
        "\n",
        ":::{.callout-warning icon=\"false\"}\n",
        "## Whether vs How\n",
        "\n",
        "Suppose you wanted to use this model to evaluate the effect of a pension program reform on savings behavior. Would you be comfortable forecasting counterfactuals with this kind of identification approach? What kind of variation in the data would help you feel that your identification approach was more credible?\n",
        "\n",
        ":::"
      ],
      "id": "5cb6fe53"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "julia-1.11",
      "language": "julia",
      "display_name": "Julia 1.11.3",
      "path": "/Users/mullinsj/Library/Jupyter/kernels/julia-1.11"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}